{% extends "base.html" %}

{% block title %}OmniLoad - Upload Files{% endblock %}

{% block content %}
<div class="chat-container" id="chatContainer">
    <div class="welcome-section">
        <h1 class="logo">üöÄ OmniLoad</h1>
        <p class="tagline">Upload files of any size and share them instantly</p>
        
        <div class="message">
            <div class="message-content" id="welcomeMessage">
                Welcome! I can help you upload and share files up to 10TB. Just drag and drop or click below to get started.
            </div>
        </div>
    </div>
    
    <div id="messageContainer"></div>
</div>

<div class="upload-section">
    <form id="uploadForm" enctype="multipart/form-data">
        <div class="upload-area" id="uploadArea">
            <div class="upload-icon">üìÅ</div>
            <p class="upload-text">Drop your file here or click to browse</p>
            <input type="file" id="fileInput" style="display: none;">
            <button type="button" class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
                Choose File
            </button>
        </div>
        
        <div class="progress-container" id="progressContainer" style="display: none;">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
            </div>
            <div class="progress-info">
                <span id="progressText">0%</span>
                <span id="progressSpeed"></span>
            </div>
        </div>
    </form>
    
    <div style="text-align: center; margin-top: 1rem;">
        <a href="/files" class="btn btn-secondary">View Recent Files</a>
        <a href="/search" class="btn btn-secondary">Search Files</a>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');
const uploadForm = document.getElementById('uploadForm');
const progressContainer = document.getElementById('progressContainer');
const progressFill = document.getElementById('progressFill');
const progressText = document.getElementById('progressText');
const progressSpeed = document.getElementById('progressSpeed');
const messageContainer = document.getElementById('messageContainer');
const chatContainer = document.getElementById('chatContainer');

// Helper function to add messages
function addMessage(content, isUser = false) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${isUser ? 'user' : ''}`;
    
    // Convert basic markdown to HTML
    let htmlContent = content;
    if (typeof content === 'string') {
        htmlContent = content
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>')
            .replace(/‚Ä¢ /g, '&bull; ')
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
    }
    
    messageDiv.innerHTML = `<div class="message-content">${htmlContent}</div>`;
    messageContainer.appendChild(messageDiv);
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Format file size
function formatFileSize(bytes) {
    const units = ['B', 'KB', 'MB', 'GB', 'TB'];
    let size = bytes;
    let unitIndex = 0;
    
    while (size >= 1024 && unitIndex < units.length - 1) {
        size /= 1024;
        unitIndex++;
    }
    
    return `${size.toFixed(1)} ${units[unitIndex]}`;
}

// Drag and drop
uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    
    if (e.dataTransfer.files.length > 0) {
        fileInput.files = e.dataTransfer.files;
        handleFileSelect(e.dataTransfer.files[0]);
    }
});

// File selection
fileInput.addEventListener('change', (e) => {
    if (e.target.files.length > 0) {
        handleFileSelect(e.target.files[0]);
    }
});

function handleFileSelect(file) {
    addMessage(`Selected: ${file.name} (${formatFileSize(file.size)})`, true);
    addMessage(`Great! I'll upload "${file.name}" for you. This should just take a moment...`);
    uploadFile(file);
}

// File upload
async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    
    // Check for library command in URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const libraryParam = urlParams.get('library');
    if (libraryParam) {
        formData.append('user_hash', libraryParam);
        addMessage(`Adding to library: ${libraryParam}`);
    }
    
    uploadArea.style.display = 'none';
    progressContainer.style.display = 'block';
    
    const startTime = Date.now();
    let lastLoaded = 0;
    let lastTime = startTime;
    
    try {
        const xhr = new XMLHttpRequest();
        
        // Track upload progress
        xhr.upload.addEventListener('progress', (e) => {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressFill.style.width = percentComplete + '%';
                progressText.textContent = percentComplete + '%';
                
                // Calculate speed
                const currentTime = Date.now();
                const timeDiff = (currentTime - lastTime) / 1000; // seconds
                const bytesDiff = e.loaded - lastLoaded;
                const speed = bytesDiff / timeDiff; // bytes per second
                
                if (timeDiff > 0.5) { // Update speed every 0.5 seconds
                    progressSpeed.textContent = `${formatFileSize(speed)}/s`;
                    lastLoaded = e.loaded;
                    lastTime = currentTime;
                }
                
                if (percentComplete === 100) {
                    progressSpeed.textContent = 'Processing...';
                }
            }
        });
        
        // Handle response
        xhr.addEventListener('load', () => {
            progressContainer.style.display = 'none';
            uploadArea.style.display = 'block';
            
            if (xhr.status === 200) {
                const data = JSON.parse(xhr.responseText);
                const shortUrl = `${window.location.origin}${data.info_url}`;
                
                addMessage(`
                    <div class="alert alert-success">
                        ‚úÖ Upload successful!
                    </div>
                    <div style="margin-top: 1rem;">
                        <strong>File:</strong> ${data.filename}<br>
                        <strong>Size:</strong> ${data.size}<br>
                        <strong>Hash:</strong> <code>${data.hash}</code><br>
                        <strong>Share URL:</strong> <a href="${data.info_url}" target="_blank">${shortUrl}</a>
                    </div>
                    <div style="margin-top: 1rem;">
                        <a href="${data.url}" target="_blank" class="btn btn-primary">Download File</a>
                        <button class="btn btn-secondary" onclick="copyToClipboard('${shortUrl}')">Copy Link</button>
                    </div>
                    <div style="margin-top: 0.5rem;">
                        <button class="btn btn-secondary" onclick="quickTag('${data.hash}', '${data.filename}')">
                            üè∑Ô∏è Quick Tag
                        </button>
                        <button class="btn btn-secondary" onclick="askAboutFile('${data.hash}', '${data.filename}')">
                            üí¨ Tell me more
                        </button>
                    </div>
                    ${data.user_hash ? `
                    <div style="margin-top: 1rem; padding: 1rem; background: var(--secondary); border-radius: var(--radius);">
                        <strong>üìö Library:</strong> 
                        <code style="cursor: pointer; padding: 0.25rem 0.5rem; background: var(--background);" 
                              onclick="copyToClipboard('library:${data.user_hash}')" 
                              title="Click to copy library command">${data.user_hash}</code><br>
                        <a href="${data.library_url}" target="_blank">View library ‚Üí</a><br>
                        <small>üí° To add files to this library: paste "library:${data.user_hash}" in your message</small>
                    </div>
                    ` : ''}
                `);
                
                // Reset form
                uploadForm.reset();
            } else {
                const data = JSON.parse(xhr.responseText);
                addMessage(`<div class="alert alert-error">‚ùå Upload failed: ${data.error}</div>`);
            }
        });
        
        xhr.addEventListener('error', () => {
            progressContainer.style.display = 'none';
            uploadArea.style.display = 'block';
            addMessage(`<div class="alert alert-error">‚ùå Upload failed. Please try again.</div>`);
        });
        
        xhr.open('POST', '/upload');
        xhr.send(formData);
        
    } catch (error) {
        progressContainer.style.display = 'none';
        uploadArea.style.display = 'block';
        addMessage(`<div class="alert alert-error">‚ùå Error: ${error.message}</div>`);
    }
}

// Copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        addMessage('Link copied to clipboard! üìã');
    }).catch(() => {
        addMessage('Failed to copy link. Please copy manually.');
    });
}

// Quick tag function
async function quickTag(fileHash, filename) {
    const tagName = prompt(`Add a tag to "${filename}":`);
    if (!tagName) return;
    
    try {
        // Get file ID first
        const filesResponse = await fetch('/files', {headers: {'Accept': 'application/json'}});
        const filesData = await filesResponse.json();
        const file = filesData.files.find(f => f.hash === fileHash);
        
        if (!file) {
            addMessage('‚ùå Could not find file to tag.');
            return;
        }
        
        // Create or find tag
        const tagResponse = await fetch('/api/tags', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({name: tagName})
        });
        
        let tagId;
        if (tagResponse.ok) {
            const tag = await tagResponse.json();
            tagId = tag.id;
        } else {
            // Tag might already exist, get all tags
            const tagsResponse = await fetch('/api/tags');
            const tagsData = await tagsResponse.json();
            const existingTag = tagsData.tags.find(t => t.name.toLowerCase() === tagName.toLowerCase());
            if (existingTag) {
                tagId = existingTag.id;
            } else {
                addMessage('‚ùå Could not create tag.');
                return;
            }
        }
        
        // Add tag to file
        const addTagResponse = await fetch(`/api/files/${file.id}/tags`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({tag_id: tagId})
        });
        
        if (addTagResponse.ok) {
            addMessage(`‚úÖ Tagged "${filename}" with "${tagName}"`);
        } else {
            addMessage('‚ùå Could not add tag to file.');
        }
    } catch (error) {
        console.error('Tagging failed:', error);
        addMessage('‚ùå Failed to add tag. Please try again.');
    }
}

// Ask about file function
async function askAboutFile(fileHash, filename) {
    try {
        // Get file metadata
        const filesResponse = await fetch('/files', {headers: {'Accept': 'application/json'}});
        const filesData = await filesResponse.json();
        const file = filesData.files.find(f => f.hash === fileHash);
        
        if (!file) {
            addMessage('‚ùå Could not find file information.');
            return;
        }
        
        // Get full metadata
        const metadataResponse = await fetch(`/api/files/${file.id}/metadata`);
        const metadata = await metadataResponse.json();
        
        let response = `Here's what I know about "${filename}":\n\n`;
        response += `üìä **File Details:**\n`;
        response += `‚Ä¢ Size: ${metadata.size}\n`;
        response += `‚Ä¢ Type: ${metadata.mime_type}\n`;
        response += `‚Ä¢ Uploaded: ${new Date(metadata.created_at).toLocaleDateString()}\n`;
        response += `‚Ä¢ Downloads: ${metadata.download_count}\n`;
        
        if (metadata.tags && metadata.tags.length > 0) {
            response += `\nüè∑Ô∏è **Tags:** ${metadata.tags.map(t => t.name).join(', ')}\n`;
        }
        
        if (metadata.description) {
            response += `\nüìù **Description:** ${metadata.description}\n`;
        }
        
        if (metadata.linked_files && metadata.linked_files.length > 0) {
            response += `\nüîó **Linked Files:** ${metadata.linked_files.length} file(s)\n`;
        }
        
        response += `\nüí° **Quick Actions:**\n`;
        response += `‚Ä¢ Add tags or description in the [file details page](${window.location.origin}/f/${fileHash.substring(0, 8)})\n`;
        response += `‚Ä¢ Link this file to related files in the gallery view\n`;
        response += `‚Ä¢ Share using the short URL: ${window.location.origin}/f/${fileHash.substring(0, 8)}`;
        
        addMessage(response);
    } catch (error) {
        console.error('Failed to get file info:', error);
        addMessage('‚ùå Could not retrieve file information.');
    }
}

// Check for library parameter in URL
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const libraryParam = urlParams.get('library');
    
    if (libraryParam) {
        // Update welcome message
        const welcomeMsg = document.getElementById('welcomeMessage');
        if (welcomeMsg) {
            welcomeMsg.innerHTML = `
                Ready to upload files to library: <code style="background: var(--background); padding: 0.25rem 0.5rem; border-radius: 0.25rem;">${libraryParam}</code><br>
                Just drag and drop your files or click below to add them to this library.
            `;
        }
        
        // Add a message about the library
        addMessage(`üìö Files will be added to library: ${libraryParam}`);
    }
});
</script>
{% endblock %} 