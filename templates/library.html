{% extends "base.html" %}

{% block title %}Library {{ user_hash[:8] }}... - OmniLoad{% endblock %}

{% block content %}
<div class="gallery-container">
    <div class="gallery-header">
        <div>
            <h1 class="logo">üìö Library</h1>
            <div class="library-info">
                <code class="library-hash" onclick="copyLibraryHash('{{ user_hash }}')" title="Click to copy library ID">
                    {{ user_hash }}
                </code>
                <p class="library-description">
                    All files in this library are grouped together. Share this URL to let others view your collection.
                </p>
            </div>
        </div>
        <div>
            <a href="/" class="btn btn-primary">Upload to Library</a>
            <a href="/files" class="btn btn-secondary">All Files</a>
            <a href="/search" class="btn btn-secondary">Search</a>
        </div>
    </div>
    
    {% if error %}
    <div class="alert alert-error">
        {{ error }}
    </div>
    {% elif files %}
    <div class="library-stats">
        <span>{{ files|length }} file{{ 's' if files|length != 1 else '' }} in this library</span>
    </div>
    
    <div class="gallery-grid">
        {% for file in files %}
        <div class="file-card enhanced" data-file-id="{{ file.id }}">
            <div class="file-card-header">
                <div class="file-icon">
                    {% if file.mime_type and file.mime_type.startswith('image/') %}
                        üñºÔ∏è
                    {% elif file.mime_type and file.mime_type.startswith('video/') %}
                        üé•
                    {% elif file.mime_type and file.mime_type.startswith('audio/') %}
                        üéµ
                    {% elif file.mime_type and 'pdf' in file.mime_type %}
                        üìÑ
                    {% elif file.mime_type and ('zip' in file.mime_type or 'rar' in file.mime_type or 'tar' in file.mime_type) %}
                        üì¶
                    {% elif file.mime_type and ('text' in file.mime_type or 'code' in file.original_filename) %}
                        üìù
                    {% else %}
                        üìÅ
                    {% endif %}
                </div>
                <div class="file-actions">
                    <button class="action-btn" onclick="editMetadata({{ file.id }})" title="Edit metadata">
                        ‚úèÔ∏è
                    </button>
                    <a href="{{ file.url }}" class="action-btn" title="Download" download>
                        ‚¨áÔ∏è
                    </a>
                </div>
            </div>
            
            <div class="file-card-body" onclick="window.location.href='{{ file.info_url }}'">
                <div class="file-name">{{ file.original_filename }}</div>
                {% if file.description %}
                <div class="file-description">{{ file.description }}</div>
                {% endif %}
                
                {% if file.tags %}
                <div class="file-tags">
                    {% for tag in file.tags %}
                    <span class="tag" data-color="{{ tag.color }}">
                        {{ tag.name }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div class="file-meta">
                    <div>{{ file.size }}</div>
                    <div>{{ file.created_at | default('Recently') }}</div>
                </div>
                {% if file.download_count > 0 %}
                <div class="file-meta">
                    <small>Downloaded {{ file.download_count }} time{{ 's' if file.download_count != 1 else '' }}</small>
                </div>
                {% endif %}
                <div class="file-hash">{{ file.hash_short }}</div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="empty-library">
        <p style="font-size: 3rem; margin-bottom: 1rem;">üì≠</p>
        <h2>No files in this library yet</h2>
        <p>Upload files with library ID <code>{{ user_hash }}</code> to see them here.</p>
        <p>Or <a href="/?library={{ user_hash }}" class="btn btn-primary">upload new files to this library</a></p>
    </div>
    {% endif %}
</div>

<!-- Share Library Modal -->
<div id="shareModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Share Library</h2>
            <button class="close-btn" onclick="closeModal('shareModal')">&times;</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label>Library URL</label>
                <input type="text" id="libraryUrl" readonly onclick="this.select()" 
                       style="width: 100%; background: var(--secondary); border: 1px solid var(--border); 
                              padding: 0.5rem; border-radius: var(--radius); color: var(--foreground);">
            </div>
            
            <div class="form-group">
                <label>Add files to this library</label>
                <p>To upload files to this library, use this command:</p>
                <code id="libraryCommand" onclick="copyToClipboard(this.textContent)" 
                      style="cursor: pointer; padding: 0.5rem; background: var(--background); 
                             border-radius: var(--radius); display: block;">
                    library:{{ user_hash }}
                </code>
                <small>Paste this in the upload chat or share with others</small>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeModal('shareModal')">Close</button>
            <button class="btn btn-primary" onclick="copyLibraryUrl()">Copy URL</button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
.library-info {
    margin: 1rem 0;
}

.library-hash {
    background: var(--background);
    padding: 0.5rem 1rem;
    border-radius: var(--radius);
    font-family: var(--font-mono);
    cursor: pointer;
    transition: all 0.2s;
    border: 1px solid var(--border);
    display: inline-block;
    margin-bottom: 0.5rem;
}

.library-hash:hover {
    border-color: var(--primary);
    background: var(--primary);
    color: white;
}

.library-description {
    color: var(--muted-foreground);
    margin: 0;
}

.library-stats {
    margin-bottom: 1rem;
    color: var(--muted-foreground);
    font-size: 0.875rem;
}

.empty-library {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--muted-foreground);
}

.empty-library h2 {
    margin-bottom: 1rem;
}

.empty-library code {
    background: var(--background);
    padding: 0.25rem 0.5rem;
    border-radius: 0.25rem;
    font-family: var(--font-mono);
}

/* Reuse styles from files.html */
.file-card.enhanced {
    position: relative;
    overflow: visible;
}

.file-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 1rem;
}

.file-actions {
    display: flex;
    gap: 0.5rem;
    opacity: 0;
    transition: opacity 0.2s;
}

.file-card:hover .file-actions {
    opacity: 1;
}

.action-btn {
    background: var(--secondary);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 0.25rem 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
    font-size: 1rem;
    text-decoration: none;
    color: var(--foreground);
    display: inline-flex;
    align-items: center;
    justify-content: center;
}

.action-btn:hover {
    background: var(--primary);
    border-color: var(--primary);
    color: white;
}

.file-description {
    color: var(--muted-foreground);
    font-size: 0.875rem;
    margin: 0.5rem 0;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
}

.file-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 0.25rem;
    margin: 0.5rem 0;
}

.tag {
    font-size: 0.75rem;
    padding: 0.125rem 0.5rem;
    border-radius: 9999px;
    border: 1px solid;
    display: inline-block;
}

/* Modal Styles */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
}

.modal-content {
    background: var(--secondary);
    border-radius: var(--radius);
    max-width: 600px;
    width: 90%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.modal-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.modal-header h2 {
    margin: 0;
}

.close-btn {
    background: none;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--muted-foreground);
    line-height: 1;
}

.modal-body {
    padding: 1.5rem;
    overflow-y: auto;
    flex: 1;
}

.modal-footer {
    padding: 1.5rem;
    border-top: 1px solid var(--border);
    display: flex;
    justify-content: flex-end;
    gap: 1rem;
}

.form-group {
    margin-bottom: 1.5rem;
}

.form-group label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.alert {
    padding: 1rem;
    border-radius: var(--radius);
    margin-bottom: 1rem;
}

.alert-error {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid #ef4444;
    color: #ef4444;
}
</style>

<script>
// Apply tag colors on page load
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.tag[data-color]').forEach(tag => {
        const color = tag.getAttribute('data-color');
        tag.style.backgroundColor = color + '20';
        tag.style.borderColor = color;
        tag.style.color = color;
    });
    
    // Set library URL in modal
    const libraryUrl = `${window.location.origin}/library/{{ user_hash }}`;
    document.getElementById('libraryUrl').value = libraryUrl;
});

function copyLibraryHash(userHash) {
    copyToClipboard(`library:${userHash}`);
    showNotification('Library ID copied! Paste this when uploading to add files to this library.');
}

function copyLibraryUrl() {
    const url = document.getElementById('libraryUrl').value;
    copyToClipboard(url);
    showNotification('Library URL copied to clipboard!');
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        console.log('Copied to clipboard:', text);
    }).catch(err => {
        console.error('Failed to copy:', err);
    });
}

function showNotification(message) {
    // Simple notification - could be improved with a toast library
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--primary);
        color: white;
        padding: 1rem 1.5rem;
        border-radius: var(--radius);
        z-index: 9999;
        animation: slideIn 0.3s ease-out;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function editMetadata(fileId) {
    // For now, redirect to file info page
    window.location.href = `/f/${fileId}`;
}
</script>

<style>
@keyframes slideIn {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}
</style>
{% endblock %} 